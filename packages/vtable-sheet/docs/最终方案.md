# VTable Sheet äº‹ä»¶æœºåˆ¶ - æœ€ç»ˆæ–¹æ¡ˆ

## ğŸ¯ æ–¹æ¡ˆæ€»ç»“

åŸºäºä½ çš„å»ºè®®ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†**å‚è€ƒ VTable ä¸­è½¬ VChart çš„æ–¹å¼**ï¼Œæä¾›äº†æ›´çµæ´»çš„äº‹ä»¶ç›‘å¬æœºåˆ¶ã€‚

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. **TableEventRelay ç±»** - é€šç”¨äº‹ä»¶ä¸­è½¬å™¨

**æ–‡ä»¶ï¼š** `src/core/table-event-relay.ts`

**åŠŸèƒ½ï¼š**
- âœ… ä¸éœ€è¦æ‰‹åŠ¨ä¸­è½¬æ¯ä¸ªäº‹ä»¶
- âœ… ç”¨æˆ·å¯ä»¥ç›‘å¬ä»»ä½• VTable äº‹ä»¶ï¼ˆåŒ…æ‹¬æœªæ¥æ–°å¢çš„ï¼‰
- âœ… è‡ªåŠ¨ç®¡ç†äº‹ä»¶ç»‘å®šå’Œè§£ç»‘
- âœ… å‚è€ƒ VTable ä¸­è½¬ VChart çš„è®¾è®¡æ¨¡å¼

**å®ç°è¦ç‚¹ï¼š**
```typescript
export class TableEventRelay {
  private _tableEventMap: Record<string, EventHandler[]> = {};
  
  // æ³¨å†Œäº‹ä»¶
  onTableEvent(type: string, callback: EventCallback): void;
  
  // ç»‘å®šåˆ° tableInstanceï¼ˆåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
  bindTableInstance(tableInstance: ListTable): void;
  
  // è§£ç»‘ï¼ˆåœ¨é”€æ¯æ—¶è°ƒç”¨ï¼‰
  unbindTableInstance(): void;
}
```

### 2. **WorkSheet é›†æˆ**

**æ–‡ä»¶ï¼š** `src/core/WorkSheet.ts`

**æ–°å¢æ–¹æ³•ï¼š**
```typescript
// ç›‘å¬ä»»ä½• VTable äº‹ä»¶
worksheet.onTableEvent(type, callback);

// ç§»é™¤ç›‘å¬å™¨
worksheet.offTableEvent(type, callback);
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```typescript
const worksheet = sheet.getActiveSheet();

// ç›‘å¬ä»»ä½• VTable äº‹ä»¶
worksheet.onTableEvent('click_cell', (event) => {
  console.log('ç‚¹å‡»äº†å•å…ƒæ ¼', event.row, event.col);
});

worksheet.onTableEvent('change_cell_value', (event) => {
  console.log('å•å…ƒæ ¼å€¼æ”¹å˜', event);
});

worksheet.onTableEvent('after_render', () => {
  console.log('æ¸²æŸ“å®Œæˆ');
});
```

## ğŸ¨ ä¸¤ç§ç›‘å¬æ–¹å¼å¯¹æ¯”

æˆ‘ä»¬ç°åœ¨æä¾›äº†**ä¸¤ç§äº’è¡¥çš„ç›‘å¬æ–¹å¼**ï¼š

### æ–¹å¼ 1ï¼šç›´æ¥è½¬å‘ (ä¸»è¦æ¨è) - `onTableEvent()`

**ä¼˜ç‚¹ï¼š**
- âœ… ä¸éœ€è¦æ‰‹åŠ¨ä¸­è½¬æ¯ä¸ªäº‹ä»¶
- âœ… å¯ä»¥ç›‘å¬ä»»ä½• VTable äº‹ä»¶
- âœ… äº‹ä»¶æ•°æ®æ˜¯åŸå§‹æ ¼å¼
- âœ… ä»£ç ç®€æ´ï¼Œç»´æŠ¤æˆæœ¬ä½
- âœ… å‚è€ƒæˆç†Ÿçš„ VChart ä¸­è½¬æ¨¡å¼

**ä½¿ç”¨åœºæ™¯ï¼š**
- ç›‘å¬å•ä¸ª sheet çš„äº¤äº’
- éœ€è¦ç›‘å¬ VTable çš„æ‰€æœ‰äº‹ä»¶
- ä¸éœ€è¦çŸ¥é“æ˜¯å“ªä¸ª sheetï¼ˆç”¨æˆ·æ˜ç¡®çŸ¥é“æ˜¯å½“å‰ sheetï¼‰

```typescript
const worksheet = sheet.getActiveSheet();

// ç›‘å¬ä»»ä½• VTable æ”¯æŒçš„äº‹ä»¶
worksheet.onTableEvent('click_cell', (event) => { ... });
worksheet.onTableEvent('scroll', (event) => { ... });
worksheet.onTableEvent('after_render', () => { ... });
```

### æ–¹å¼ 2ï¼šç±»å‹å®‰å…¨åŒ…è£… (å¯é€‰) - `on(EventType)`

**ä¼˜ç‚¹ï¼š**
- âœ… è‡ªåŠ¨é™„å¸¦ `sheetKey`
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… å¯ä»¥åœ¨ VTableSheet å±‚ç»Ÿä¸€ç›‘å¬æ‰€æœ‰ sheet

**ä½¿ç”¨åœºæ™¯ï¼š**
- éœ€è¦ç›‘å¬æ‰€æœ‰ sheet çš„äº‹ä»¶
- éœ€è¦çŸ¥é“æ˜¯å“ªä¸ª sheet è§¦å‘çš„
- éœ€è¦ TypeScript ç±»å‹æ”¯æŒ

```typescript
import { TableEventType } from '@visactor/vtable-sheet';

// åœ¨ VTableSheet å±‚ç»Ÿä¸€ç›‘å¬
sheet.on(TableEventType.CHANGE_CELL_VALUE, (event) => {
  console.log(`Sheet ${event.sheetKey} çš„å•å…ƒæ ¼ç¼–è¾‘`);
});
```

## ğŸ“Š å®ç°çŠ¶æ€

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| TableEventRelay ç±» | âœ… å·²å®Œæˆ | é€šç”¨äº‹ä»¶ä¸­è½¬å™¨ |
| WorkSheet é›†æˆ | âœ… å·²å®Œæˆ | æ·»åŠ  onTableEvent/offTableEvent æ–¹æ³• |
| ç±»å‹å®šä¹‰ | âœ… å·²å®Œæˆ | å®Œæ•´çš„äº‹ä»¶ç±»å‹å®šä¹‰ |
| ä½¿ç”¨æ–‡æ¡£ | âœ… å·²å®Œæˆ | è¯¦ç»†çš„ä½¿ç”¨ç¤ºä¾‹ |
| TypedEventTarget | âœ… å·²å®Œæˆ | ç±»å‹å®‰å…¨çš„äº‹ä»¶åŸºç±» |
| SpreadSheet äº‹ä»¶ | â³ å¾…å®ç° | Sheet ç®¡ç†äº‹ä»¶ |
| WorkSheet äº‹ä»¶ | â³ å¾…å®ç° | å…¬å¼è®¡ç®—äº‹ä»¶ |

## ğŸ’¡ è®¾è®¡å†³ç­–

### ä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§æ–¹æ¡ˆï¼Ÿ

1. **å‚è€ƒæˆç†Ÿæ¨¡å¼** - VTable ä¸­è½¬ VChart çš„æ–¹å¼å·²ç»éªŒè¯è¿‡ï¼Œç¨³å®šå¯é 
2. **çµæ´»æ€§** - ç”¨æˆ·å¯ä»¥ç›‘å¬ä»»ä½• VTable äº‹ä»¶ï¼ŒåŒ…æ‹¬æœªæ¥æ–°å¢çš„
3. **ä½ç»´æŠ¤æˆæœ¬** - ä¸éœ€è¦æ‰‹åŠ¨ä¸­è½¬æ¯ä¸ªäº‹ä»¶
4. **å‘åå…¼å®¹** - å¯ä»¥éšæ—¶æ·»åŠ åŒ…è£…äº‹ä»¶ï¼Œä¸å½±å“ç°æœ‰ API
5. **ç”¨æˆ·å‹å¥½** - ç®€å•ç›´è§‚ï¼Œç¬¦åˆ JavaScript äº‹ä»¶ç›‘å¬ä¹ æƒ¯

### å…³äº sheetKey çš„å†³ç­–

**ä½ è¯´å¾—å¯¹ï¼š"å…¶å®ä¸é™„å¸¦ä¹Ÿå¯ä»¥ ç”¨æˆ·çŸ¥é“æ˜¯å“ªä¸ªå®ä¾‹"**

æˆ‘ä»¬é‡‡ç”¨äº†**åˆ†å±‚è®¾è®¡**ï¼š

1. **WorkSheet å±‚** (`onTableEvent`)
   - âŒ ä¸é™„å¸¦ sheetKey
   - âœ… ç”¨æˆ·æ˜ç¡®çŸ¥é“æ˜¯å“ªä¸ª worksheet
   - âœ… æ›´ç®€å•ç›´æ¥
   - âœ… é€‚åˆç›‘å¬å•ä¸ª sheet

2. **VTableSheet å±‚** (åŒ…è£…äº‹ä»¶ï¼Œæœªæ¥å¯é€‰å®ç°)
   - âœ… é™„å¸¦ sheetKey
   - âœ… ç»Ÿä¸€ç›‘å¬æ‰€æœ‰ sheet
   - âœ… é€‚åˆéœ€è¦åŒºåˆ† sheet çš„åœºæ™¯

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: å•ä¸ª Sheet çš„äº¤äº’

```typescript
const worksheet = sheet.getActiveSheet();

// ç›‘å¬å•å…ƒæ ¼ç‚¹å‡»
worksheet.onTableEvent('click_cell', (event) => {
  console.log(`ç‚¹å‡»äº† [${event.row}, ${event.col}]`);
  const value = worksheet.getCellValue(event.col, event.row);
  console.log('å€¼:', value);
});

// ç›‘å¬ç¼–è¾‘
worksheet.onTableEvent('change_cell_value', (event) => {
  console.log('ç¼–è¾‘:', event.rawValue, 'â†’', event.changedValue);
  autoSave(event);
});

// ç›‘å¬é€‰æ‹©
worksheet.onTableEvent('selected_changed', (event) => {
  console.log('é€‰æ‹©èŒƒå›´:', event.ranges);
});
```

### ç¤ºä¾‹ 2: ç›‘å¬æ‰€æœ‰ VTable äº‹ä»¶

```typescript
const worksheet = sheet.getActiveSheet();

// æ»šåŠ¨
worksheet.onTableEvent('scroll', (event) => {
  console.log('æ»šåŠ¨:', event.scrollTop, event.scrollLeft);
});

// æ¸²æŸ“
worksheet.onTableEvent('after_render', () => {
  console.log('æ¸²æŸ“å®Œæˆ');
});

// è°ƒæ•´å¤§å°
worksheet.onTableEvent('resize_column_end', (event) => {
  console.log(`åˆ— ${event.col} å®½åº¦: ${event.width}`);
});

// æ’åº
worksheet.onTableEvent('after_sort', (event) => {
  console.log('æ’åºå®Œæˆ:', event);
});

// å¤åˆ¶ç²˜è´´
worksheet.onTableEvent('copy_data', (event) => {
  console.log('å¤åˆ¶:', event);
});

worksheet.onTableEvent('pasted_data', (event) => {
  console.log('ç²˜è´´:', event);
});
```

### ç¤ºä¾‹ 3: æ¸…ç†ç›‘å¬å™¨

```typescript
const worksheet = sheet.getActiveSheet();

const handleClick = (event) => {
  console.log('ç‚¹å‡»', event);
};

// æ³¨å†Œ
worksheet.onTableEvent('click_cell', handleClick);

// ç§»é™¤
worksheet.offTableEvent('click_cell', handleClick);
```

### ç¤ºä¾‹ 4: åˆ‡æ¢ Sheet æ—¶æ›´æ–°ç›‘å¬

```typescript
import { SpreadSheetEventType } from '@visactor/vtable-sheet';

let currentHandlers = [];

sheet.on(SpreadSheetEventType.SHEET_ACTIVATED, (event) => {
  const worksheet = sheet.getActiveSheet();
  
  // æ¸…ç†æ—§ç›‘å¬å™¨
  currentHandlers.forEach(({ type, handler }) => {
    worksheet.offTableEvent(type, handler);
  });
  currentHandlers = [];
  
  // æ·»åŠ æ–°ç›‘å¬å™¨
  const clickHandler = (e) => {
    console.log(`${event.sheetTitle} ç‚¹å‡»äº† [${e.row}, ${e.col}]`);
  };
  
  worksheet.onTableEvent('click_cell', clickHandler);
  currentHandlers.push({ type: 'click_cell', handler: clickHandler });
});
```

## ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ï¼Œå¯ä»¥ç»§ç»­å®ç°åŒ…è£…äº‹ä»¶ï¼ˆå¸¦ sheetKey çš„ç»Ÿä¸€ç›‘å¬ï¼‰ï¼š

### ç¬¬ä¸€é˜¶æ®µï¼šSpreadSheet äº‹ä»¶
- âœ… Sheet ç®¡ç†ï¼ˆæ·»åŠ /åˆ é™¤/åˆ‡æ¢ï¼‰
- âœ… å¯¼å…¥/å¯¼å‡º
- âœ… è·¨ Sheet æ“ä½œ

### ç¬¬äºŒé˜¶æ®µï¼šWorkSheet äº‹ä»¶
- âœ… å…¬å¼è®¡ç®—
- âœ… æ•°æ®åŠ è½½/æ’åº/ç­›é€‰
- âœ… ç¼–è¾‘çŠ¶æ€

ä½†æ˜¯åŸºäºä½ çš„å»ºè®®ï¼Œ**ä¸»è¦æ¨èä½¿ç”¨ `onTableEvent()` æ–¹å¼**ï¼Œå› ä¸ºï¼š
- âœ… æ›´ç®€å•ç›´æ¥
- âœ… æ›´çµæ´»å¼ºå¤§
- âœ… æ›´ä½ç»´æŠ¤æˆæœ¬
- âœ… ç”¨æˆ·æ˜ç¡®çŸ¥é“æ˜¯å“ªä¸ªå®ä¾‹

## ğŸ“ ç›¸å…³æ–‡ä»¶

1. **æ ¸å¿ƒå®ç°**
   - `src/core/table-event-relay.ts` - äº‹ä»¶ä¸­è½¬å™¨
   - `src/core/WorkSheet.ts` - WorkSheet é›†æˆ

2. **ç±»å‹å®šä¹‰**
   - `src/ts-types/spreadsheet-events.ts` - å®Œæ•´çš„äº‹ä»¶ç±»å‹
   - `src/event/typed-event-target.ts` - ç±»å‹å®‰å…¨çš„äº‹ä»¶åŸºç±»

3. **æ–‡æ¡£**
   - `docs/event-usage-examples.zh-CN.md` - è¯¦ç»†ä½¿ç”¨ç¤ºä¾‹
   - `docs/event-system-guide.md` - ç³»ç»Ÿè®¾è®¡æŒ‡å—
   - `docs/event-implementation-plan.zh-CN.md` - å®ç°æ–¹æ¡ˆ
   - `docs/äº‹ä»¶ç³»ç»Ÿæ–¹æ¡ˆæ€»ç»“.md` - æ–¹æ¡ˆæ€»ç»“
   - `docs/æœ€ç»ˆæ–¹æ¡ˆ.md` - æœ¬æ–‡ä»¶

## âœ… æ€»ç»“

ä½ çš„å»ºè®®éå¸¸å¥½ï¼å‚è€ƒ VTable ä¸­è½¬ VChart çš„æ–¹å¼ç¡®å®æ›´ä¼˜é›…ï¼š

**ä¼˜ç‚¹ï¼š**
- âœ… ä¸éœ€è¦æ‰‹åŠ¨ä¸­è½¬æ¯ä¸ªäº‹ä»¶
- âœ… ç”¨æˆ·å¯ä»¥ç›‘å¬ä»»ä½• VTable äº‹ä»¶
- âœ… ä»£ç ç®€æ´ï¼Œç»´æŠ¤æˆæœ¬ä½
- âœ… ç¬¦åˆç”¨æˆ·ä¹ æƒ¯ï¼ˆçŸ¥é“æ˜¯å“ªä¸ªå®ä¾‹ï¼‰

**å®ç°æ–¹å¼ï¼š**
```typescript
// ç®€å•ç›´æ¥
const worksheet = sheet.getActiveSheet();
worksheet.onTableEvent('click_cell', handler);
worksheet.onTableEvent('change_cell_value', handler);
worksheet.onTableEvent('ä»»ä½•VTableäº‹ä»¶', handler);
```

è¿™ä¸ªæ–¹æ¡ˆæ—¢çµæ´»åˆç®€å•ï¼Œç”¨æˆ·ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ï¼ğŸ‰


