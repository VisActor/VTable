# VTable Sheet ç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿ - ä½¿ç”¨ç¤ºä¾‹

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**ä¸€åˆ‡äº‹ä»¶ç›‘å¬éƒ½é€šè¿‡ `sheet.onTableEvent()` å®Œæˆ**

- âœ… å†…éƒ¨ç»„ä»¶ä½¿ç”¨å®ƒ
- âœ… å¤–éƒ¨ç”¨æˆ·ä½¿ç”¨å®ƒ
- âœ… æ‰€æœ‰äº‹ä»¶è‡ªåŠ¨å¸¦ `sheetKey`

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºç¡€ç”¨æ³• - ç›‘å¬å•ä¸ªäº‹ä»¶

```typescript
const sheet = new VTableSheet(container, {
  sheets: [
    { name: 'Sheet1', data: [...] },
    { name: 'Sheet2', data: [...] }
  ]
});

// ç›‘å¬æ‰€æœ‰ sheet çš„å•å…ƒæ ¼ç‚¹å‡»
sheet.onTableEvent('click_cell', (event) => {
  console.log(`Sheet ${event.sheetKey} çš„å•å…ƒæ ¼è¢«ç‚¹å‡»`);
  console.log(`ä½ç½®: [${event.row}, ${event.col}]`);
  console.log(`å€¼: ${event.value}`);
});
```

### 2. ç›‘å¬å¤šä¸ªäº‹ä»¶

```typescript
// ç›‘å¬å•å…ƒæ ¼ç¼–è¾‘
sheet.onTableEvent('change_cell_value', (event) => {
  console.log(`Sheet ${event.sheetKey} ç¼–è¾‘`);
  console.log(`æ—§å€¼: ${event.rawValue}`);
  console.log(`æ–°å€¼: ${event.changedValue}`);
  
  // è‡ªåŠ¨ä¿å­˜
  autoSave(event.sheetKey, event.row, event.col, event.changedValue);
});

// ç›‘å¬é€‰æ‹©èŒƒå›´å˜åŒ–
sheet.onTableEvent('selected_changed', (event) => {
  console.log(`Sheet ${event.sheetKey} é€‰æ‹©èŒƒå›´å˜åŒ–`);
  console.log('é€‰æ‹©èŒƒå›´:', event.ranges);
  
  // æ›´æ–°å·¥å…·æ çŠ¶æ€
  updateToolbar(event.ranges);
});

// ç›‘å¬æ»šåŠ¨
sheet.onTableEvent('scroll', (event) => {
  console.log(`Sheet ${event.sheetKey} æ»šåŠ¨`);
  console.log(`æ»šåŠ¨ä½ç½®: [${event.scrollLeft}, ${event.scrollTop}]`);
});
```

### 3. å–æ¶ˆç›‘å¬

```typescript
// å®šä¹‰å›è°ƒå‡½æ•°
const handleCellClick = (event) => {
  console.log('å•å…ƒæ ¼è¢«ç‚¹å‡»:', event);
};

// æ³¨å†Œç›‘å¬
sheet.onTableEvent('click_cell', handleCellClick);

// å–æ¶ˆç›‘å¬
sheet.offTableEvent('click_cell', handleCellClick);

// å–æ¶ˆæŸä¸ªäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨
sheet.offTableEvent('click_cell');
```

### 4. æ ¹æ® sheetKey åŒºåˆ†å¤„ç†

```typescript
sheet.onTableEvent('click_cell', (event) => {
  // æ ¹æ®ä¸åŒçš„ sheet æ‰§è¡Œä¸åŒçš„é€»è¾‘
  switch (event.sheetKey) {
    case 'sales':
      handleSalesSheetClick(event);
      break;
    case 'inventory':
      handleInventorySheetClick(event);
      break;
    default:
      handleDefaultClick(event);
  }
});
```

### 5. ç›‘å¬ç‰¹å®š sheet çš„äº‹ä»¶

```typescript
// æ–¹æ¡ˆ 1ï¼šåœ¨å›è°ƒä¸­è¿‡æ»¤
sheet.onTableEvent('click_cell', (event) => {
  if (event.sheetKey === 'Sheet1') {
    console.log('åªå¤„ç† Sheet1 çš„ç‚¹å‡»');
  }
});

// æ–¹æ¡ˆ 2ï¼šè·å– WorkSheet å®ä¾‹åç›‘å¬ï¼ˆä¸æ¨èï¼‰
// ç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿåä¸éœ€è¦è¿™æ ·åšäº†
```

### 6. ç›‘å¬å¤šä¸ªç›¸å…³äº‹ä»¶

```typescript
// ç›‘å¬ç¼–è¾‘æµç¨‹çš„æ‰€æœ‰äº‹ä»¶
const editEvents = [
  'change_cell_value',
  'after_change_cell_value',
  'before_change_cell_value'
];

editEvents.forEach(eventType => {
  sheet.onTableEvent(eventType, (event) => {
    console.log(`[${eventType}] Sheet ${event.sheetKey}:`, event);
  });
});
```

### 7. å®æˆ˜æ¡ˆä¾‹ï¼šè‡ªåŠ¨ä¿å­˜

```typescript
let saveTimer = null;

sheet.onTableEvent('change_cell_value', (event) => {
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (saveTimer) {
    clearTimeout(saveTimer);
  }
  
  // å»¶è¿Ÿä¿å­˜ï¼ˆé˜²æŠ–ï¼‰
  saveTimer = setTimeout(() => {
    const data = {
      sheetKey: event.sheetKey,
      row: event.row,
      col: event.col,
      value: event.changedValue,
      timestamp: Date.now()
    };
    
    // å‘é€åˆ°æœåŠ¡å™¨
    fetch('/api/save', {
      method: 'POST',
      body: JSON.stringify(data)
    }).then(() => {
      console.log(`Sheet ${event.sheetKey} è‡ªåŠ¨ä¿å­˜æˆåŠŸ`);
    });
  }, 1000);
});
```

### 8. å®æˆ˜æ¡ˆä¾‹ï¼šå•å…ƒæ ¼å˜åŒ–å†å²è®°å½•

```typescript
const history = [];

sheet.onTableEvent('change_cell_value', (event) => {
  history.push({
    sheetKey: event.sheetKey,
    row: event.row,
    col: event.col,
    oldValue: event.rawValue,
    newValue: event.changedValue,
    timestamp: Date.now()
  });
  
  console.log('å†å²è®°å½•:', history);
});

// æ’¤é”€åŠŸèƒ½
function undo() {
  if (history.length === 0) return;
  
  const lastChange = history.pop();
  const worksheet = sheet.getWorkSheetByKey(lastChange.sheetKey);
  worksheet.setCellValue(lastChange.col, lastChange.row, lastChange.oldValue);
}
```

### 9. å®æˆ˜æ¡ˆä¾‹ï¼šååŒç¼–è¾‘

```typescript
// ç›‘å¬æœ¬åœ°ç¼–è¾‘ï¼Œå¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
sheet.onTableEvent('change_cell_value', (event) => {
  // å‘é€ç¼–è¾‘äº‹ä»¶åˆ°å…¶ä»–ç”¨æˆ·
  websocket.send(JSON.stringify({
    type: 'cell_changed',
    sheetKey: event.sheetKey,
    row: event.row,
    col: event.col,
    value: event.changedValue,
    user: currentUser.id
  }));
});

// æ¥æ”¶å…¶ä»–ç”¨æˆ·çš„ç¼–è¾‘
websocket.onmessage = (msg) => {
  const data = JSON.parse(msg.data);
  
  if (data.type === 'cell_changed' && data.user !== currentUser.id) {
    const worksheet = sheet.getWorkSheetByKey(data.sheetKey);
    worksheet.setCellValue(data.col, data.row, data.value);
  }
};
```

### 10. å†…éƒ¨ç»„ä»¶ä½¿ç”¨ï¼ˆEventManagerï¼‰

```typescript
// EventManager.ts
private setupTableEventListeners(): void {
  // å†…éƒ¨ç»„ä»¶ä¹Ÿä½¿ç”¨ç›¸åŒçš„ API
  this.sheet.onTableEvent('click_cell', (event) => {
    // å†…éƒ¨é€»è¾‘ï¼šæ›´æ–°å…¬å¼æ 
    if (!this.sheet.formulaManager.formulaWorkingOnCell) {
      const formulaUIManager = this.sheet.formulaUIManager;
      formulaUIManager.isFormulaBarShowingResult = false;
      formulaUIManager.clearFormula();
      formulaUIManager.updateFormulaBar();
    }
  });

  this.sheet.onTableEvent('change_cell_value', (event) => {
    // å†…éƒ¨é€»è¾‘ï¼šæ›´æ–°å…¬å¼å¼•æ“
    this.sheet.formulaManager.formulaRangeSelector.handleCellValueChanged(event);
  });

  this.sheet.onTableEvent('selected_changed', (event) => {
    // å†…éƒ¨é€»è¾‘ï¼šå…¬å¼èŒƒå›´é€‰æ‹©
    this.sheet.formulaManager.formulaRangeSelector.handleSelectionChangedForRangeMode(event);
  });
}
```

## ğŸ¯ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

```typescript
// 1. ä½¿ç”¨ç»Ÿä¸€çš„ onTableEvent API
sheet.onTableEvent('click_cell', handler);

// 2. åœ¨å›è°ƒä¸­ä½¿ç”¨ sheetKey åŒºåˆ†
sheet.onTableEvent('click_cell', (event) => {
  if (event.sheetKey === 'Sheet1') {
    // å¤„ç† Sheet1
  }
});

// 3. ä½¿ç”¨å‘½åå‡½æ•°ï¼Œæ–¹ä¾¿å–æ¶ˆç›‘å¬
const handleClick = (event) => { /* ... */ };
sheet.onTableEvent('click_cell', handleClick);
sheet.offTableEvent('click_cell', handleClick);

// 4. åˆ©ç”¨é˜²æŠ–/èŠ‚æµä¼˜åŒ–æ€§èƒ½
const debouncedHandler = debounce((event) => {
  // å¤„ç†é€»è¾‘
}, 300);
sheet.onTableEvent('change_cell_value', debouncedHandler);
```

### âŒ ä¸æ¨èåšæ³•

```typescript
// âŒ ä¸è¦å°è¯•ç›´æ¥ç›‘å¬ WorkSheet å®ä¾‹
// WorkSheet ä¸å†ç»§æ‰¿ EventTarget
const worksheet = sheet.getWorkSheetByKey('Sheet1');
worksheet.on('click_cell', handler); // âŒ è¿™ä¸ä¼šå·¥ä½œ

// âŒ ä¸è¦åœ¨å¾ªç¯ä¸­åˆ›å»ºåŒ¿åå‡½æ•°ç›‘å¬å™¨
for (let i = 0; i < 10; i++) {
  sheet.onTableEvent('click_cell', (event) => { // âŒ éš¾ä»¥å–æ¶ˆç›‘å¬
    console.log(i);
  });
}

// âœ… åº”è¯¥è¿™æ ·
const handlers = [];
for (let i = 0; i < 10; i++) {
  const handler = (event) => {
    console.log(i);
  };
  handlers.push(handler);
  sheet.onTableEvent('click_cell', handler);
}
```

## ğŸ“ æ”¯æŒçš„æ‰€æœ‰ VTable äº‹ä»¶

```typescript
// é¼ æ ‡äº‹ä»¶
'click_cell'
'dblclick_cell'
'mousedown_cell'
'mouseup_cell'
'mouseenter_cell'
'mouseleave_cell'
'mousemove_cell'
'contextmenu_cell'

// é€‰æ‹©äº‹ä»¶
'selected_changed'
'drag_select_end'

// ç¼–è¾‘äº‹ä»¶
'change_cell_value'
'after_change_cell_value'
'before_change_cell_value'

// æ•°æ®å˜åŒ–äº‹ä»¶
'add_record'
'delete_record'
'add_column'
'delete_column'
'change_header_position'

// æ»šåŠ¨å’Œæ¸²æŸ“äº‹ä»¶
'scroll'
'after_render'
'after_container_resize'

// ... ä»¥åŠæ›´å¤š VTable äº‹ä»¶
```

## ğŸ‰ æ€»ç»“

ä½¿ç”¨ç»Ÿä¸€çš„ `onTableEvent()` APIï¼š

1. âœ… **ç®€å•** - åªéœ€è¦è®°ä½ä¸€ä¸ª API
2. âœ… **çµæ´»** - å¯ä»¥ç›‘å¬ä»»ä½• VTable äº‹ä»¶
3. âœ… **ç»Ÿä¸€** - å†…éƒ¨å’Œå¤–éƒ¨éƒ½ç”¨ç›¸åŒçš„æ–¹å¼
4. âœ… **è‡ªåŠ¨** - `sheetKey` è‡ªåŠ¨é™„å¸¦
5. âœ… **ç±»å‹å®‰å…¨** - TypeScript æ”¯æŒ

---

**å¼€å§‹ä½¿ç”¨ç»Ÿä¸€äº‹ä»¶ç³»ç»Ÿï¼Œè®©ä»£ç æ›´ç®€æ´ï¼** ğŸš€


