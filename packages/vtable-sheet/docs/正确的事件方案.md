# VTable Sheet äº‹ä»¶æœºåˆ¶ - æ­£ç¡®æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒè®¾è®¡

åŸºäºä½ çš„æ­£ç¡®ç†è§£ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ¸…æ™°ç®€æ´çš„äº‹ä»¶ç³»ç»Ÿï¼š

### æ ¸å¿ƒç‰¹ç‚¹

1. **äº‹ä»¶ç»‘å®šåœ¨ VTableSheet å±‚** - `sheet.onTableEvent()`
2. **è‡ªåŠ¨é™„å¸¦ sheetKey** - äº‹ä»¶å›è°ƒå‚æ•°è‡ªåŠ¨åŒ…å« `event.sheetKey`
3. **åªæœ‰ä¸€ç§ç›‘å¬æ–¹å¼** - ç®€å•ç»Ÿä¸€
4. **å‚è€ƒ VTable ä¸­è½¬ VChart** - æˆç†Ÿçš„è®¾è®¡æ¨¡å¼

### å…³é”®ç†è§£

- âŒ **ä¸æ˜¯** åœ¨å•ä¸ª WorkSheet ä¸Šç›‘å¬ï¼ˆé‚£æ ·åˆ‡æ¢ sheet åäº‹ä»¶å°±å¤±æ•ˆäº†ï¼‰
- âœ… **è€Œæ˜¯** åœ¨ VTableSheet å±‚ç»Ÿä¸€ç›‘å¬æ‰€æœ‰ sheet
- âœ… æ¯ä¸ª sheet çš„ tableInstance è§¦å‘äº‹ä»¶æ—¶ï¼Œè‡ªåŠ¨é™„å¸¦ sheetKey
- âœ… ç”¨æˆ·åœ¨å›è°ƒä¸­çŸ¥é“æ˜¯å“ªä¸ª sheet è§¦å‘çš„

## ğŸ“ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬ç”¨æ³•

```typescript
import { VTableSheet } from '@visactor/vtable-sheet';

const sheet = new VTableSheet(container, {
  sheets: [/* ... */]
});

// åœ¨ VTableSheet å±‚ç›‘å¬ï¼ˆä¸æ˜¯åœ¨ WorkSheet å±‚ï¼‰
sheet.onTableEvent('click_cell', (event) => {
  // event.sheetKey - è‡ªåŠ¨é™„å¸¦ï¼Œå‘Šè¯‰ä½ æ˜¯å“ªä¸ª sheet
  // event.row - åŸå§‹ VTable äº‹ä»¶çš„å±æ€§
  // event.col - åŸå§‹ VTable äº‹ä»¶çš„å±æ€§
  console.log(`Sheet ${event.sheetKey} çš„å•å…ƒæ ¼ [${event.row}, ${event.col}] è¢«ç‚¹å‡»`);
});

// ç›‘å¬å•å…ƒæ ¼å€¼æ”¹å˜
sheet.onTableEvent('change_cell_value', (event) => {
  console.log(`Sheet ${event.sheetKey} çš„å€¼æ”¹å˜`);
  console.log('æ—§å€¼:', event.rawValue);
  console.log('æ–°å€¼:', event.changedValue);
  
  // è‡ªåŠ¨ä¿å­˜
  saveToServer({
    sheetKey: event.sheetKey,
    row: event.row,
    col: event.col,
    value: event.changedValue
  });
});

// å¯ä»¥ç›‘å¬ä»»ä½• VTable æ”¯æŒçš„äº‹ä»¶
sheet.onTableEvent('scroll', (event) => {
  console.log(`Sheet ${event.sheetKey} æ»šåŠ¨äº†`);
});

sheet.onTableEvent('after_render', (event) => {
  console.log(`Sheet ${event.sheetKey} æ¸²æŸ“å®Œæˆ`);
});
```

### å®Œæ•´ç¤ºä¾‹

```typescript
// åˆ›å»ºç”µå­è¡¨æ ¼
const sheet = new VTableSheet(container, {
  sheets: [
    { sheetKey: 'sheet1', sheetTitle: 'Sheet 1', data: [[...]] },
    { sheetKey: 'sheet2', sheetTitle: 'Sheet 2', data: [[...]] }
  ]
});

// ç›‘å¬æ‰€æœ‰ sheet çš„å•å…ƒæ ¼ç‚¹å‡»
sheet.onTableEvent('click_cell', (event) => {
  console.log(`Sheet ${event.sheetKey} ç‚¹å‡»äº† [${event.row}, ${event.col}]`);
});

// ç›‘å¬æ‰€æœ‰ sheet çš„ç¼–è¾‘
sheet.onTableEvent('change_cell_value', (event) => {
  console.log(`Sheet ${event.sheetKey} ç¼–è¾‘`);
  autoSave(event);
});

// ç›‘å¬é€‰æ‹©å˜åŒ–
sheet.onTableEvent('selected_changed', (event) => {
  console.log(`Sheet ${event.sheetKey} é€‰æ‹©èŒƒå›´:`, event.ranges);
});

// ç›‘å¬è¡Œåˆ—æ“ä½œ
sheet.onTableEvent('add_record', (event) => {
  console.log(`Sheet ${event.sheetKey} æ·»åŠ äº† ${event.recordCount} è¡Œ`);
});

sheet.onTableEvent('delete_record', (event) => {
  console.log(`Sheet ${event.sheetKey} åˆ é™¤äº† ${event.deletedCount} è¡Œ`);
});

// ç›‘å¬è°ƒæ•´å¤§å°
sheet.onTableEvent('resize_column_end', (event) => {
  console.log(`Sheet ${event.sheetKey} åˆ— ${event.col} å®½åº¦: ${event.width}`);
});

// ç›‘å¬æ’åº
sheet.onTableEvent('after_sort', (event) => {
  console.log(`Sheet ${event.sheetKey} æ’åºå®Œæˆ`);
});

// åˆ‡æ¢ sheet ä¹Ÿä¸å½±å“ï¼Œå› ä¸ºäº‹ä»¶ç»‘å®šåœ¨ VTableSheet å±‚
sheet.activateSheet('sheet2'); // äº‹ä»¶ç»§ç»­æœ‰æ•ˆ
```

## ğŸ”§ å®ç°åŸç†

### 1. TableEventRelay ç±»

```typescript
// åœ¨ VTableSheet åˆå§‹åŒ–æ—¶åˆ›å»º
this.tableEventRelay = new TableEventRelay(this);
```

æ ¸å¿ƒåŠŸèƒ½ï¼š
- å­˜å‚¨ç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶ç›‘å¬å™¨
- å½“ WorkSheet åˆå§‹åŒ–æ—¶ï¼Œä¸ºå…¶ tableInstance ç»‘å®šäº‹ä»¶
- äº‹ä»¶è§¦å‘æ—¶ï¼Œè‡ªåŠ¨é™„å¸¦ sheetKey
- ç®¡ç†å¤šä¸ª sheet çš„äº‹ä»¶ç»‘å®š/è§£ç»‘

### 2. äº‹ä»¶æµç¨‹

```
ç”¨æˆ·æ³¨å†Œ
    â†“
sheet.onTableEvent('click_cell', callback)
    â†“
TableEventRelay å­˜å‚¨å›è°ƒ
    â†“
ä¸ºæ¯ä¸ª WorkSheet çš„ tableInstance ç»‘å®šåŒ…è£…å‡½æ•°
    â†“
tableInstance è§¦å‘åŸå§‹äº‹ä»¶
    â†“
åŒ…è£…å‡½æ•°æ‹¦æˆªï¼Œæ·»åŠ  sheetKey
    â†“
è°ƒç”¨ç”¨æˆ·çš„ callback({ sheetKey, ...åŸå§‹äº‹ä»¶ })
```

### 3. å¢å¼ºçš„äº‹ä»¶å¯¹è±¡

```typescript
// åŸå§‹ VTable äº‹ä»¶
{
  row: 5,
  col: 3,
  value: 'Hello',
  event: MouseEvent
}

// å¢å¼ºåçš„äº‹ä»¶å¯¹è±¡ï¼ˆè‡ªåŠ¨é™„å¸¦ sheetKeyï¼‰
{
  sheetKey: 'sheet1',  // è‡ªåŠ¨æ·»åŠ 
  row: 5,
  col: 3,
  value: 'Hello',
  event: MouseEvent
}
```

## âœ… æ ¸å¿ƒä¼˜åŠ¿

### 1. äº‹ä»¶ä¸ä¼šå¤±æ•ˆ

```typescript
// âŒ é”™è¯¯çš„æ–¹å¼ï¼ˆæˆ‘æœ€åˆç†è§£é”™äº†ï¼‰
const worksheet = sheet.getActiveSheet();
worksheet.onTableEvent('click_cell', handler); // åˆ‡æ¢ sheet åå¤±æ•ˆ

// âœ… æ­£ç¡®çš„æ–¹å¼
sheet.onTableEvent('click_cell', (event) => {
  // æ— è®ºåˆ‡æ¢åˆ°å“ªä¸ª sheetï¼Œäº‹ä»¶éƒ½æœ‰æ•ˆ
  console.log(`Sheet ${event.sheetKey} è¢«ç‚¹å‡»`);
});
```

### 2. è‡ªåŠ¨é™„å¸¦ sheetKey

```typescript
// ç”¨æˆ·ä¸éœ€è¦æ‰‹åŠ¨åˆ¤æ–­æ˜¯å“ªä¸ª sheet
sheet.onTableEvent('change_cell_value', (event) => {
  // event.sheetKey è‡ªåŠ¨å‘Šè¯‰ä½ æ˜¯å“ªä¸ª sheet
  if (event.sheetKey === 'sheet1') {
    // åªå¤„ç† sheet1 çš„ç¼–è¾‘
  }
});
```

### 3. å¯ä»¥ç›‘å¬ä»»ä½• VTable äº‹ä»¶

```typescript
// ä¸éœ€è¦æ‰‹åŠ¨ä¸­è½¬ï¼Œä»»ä½• VTable äº‹ä»¶éƒ½å¯ä»¥ç›‘å¬
sheet.onTableEvent('click_cell', handler);
sheet.onTableEvent('scroll', handler);
sheet.onTableEvent('after_render', handler);
sheet.onTableEvent('resize_column_end', handler);
sheet.onTableEvent('ä»»ä½•VTableäº‹ä»¶', handler);
```

### 4. ç®€å•ç»Ÿä¸€

```typescript
// åªæœ‰ä¸€ç§ç›‘å¬æ–¹å¼ï¼Œç®€å•æ˜“ç”¨
sheet.onTableEvent(eventType, callback);
sheet.offTableEvent(eventType, callback);
```

## ğŸ†š å¯¹æ¯”ä¹‹å‰çš„è¯¯è§£

| é¡¹ç›® | æˆ‘æœ€åˆçš„ç†è§£ï¼ˆé”™è¯¯ï¼‰ | ä½ çš„æ­£ç¡®ç†è§£ |
|------|------------------|------------|
| ç»‘å®šä½ç½® | WorkSheet å±‚ | VTableSheet å±‚ |
| åˆ‡æ¢ sheet | äº‹ä»¶å¤±æ•ˆ | äº‹ä»¶ç»§ç»­æœ‰æ•ˆ |
| sheetKey | ä¸é™„å¸¦ | è‡ªåŠ¨é™„å¸¦ |
| ç”¨æˆ·ä½“éªŒ | éœ€è¦é‡æ–°ç»‘å®š | ä¸€æ¬¡ç»‘å®šï¼Œæ°¸ä¹…æœ‰æ•ˆ |

### ä¹‹å‰çš„é”™è¯¯ç†è§£

```typescript
// âŒ æˆ‘ä¹‹å‰é”™è¯¯åœ°è¿™æ ·è®¾è®¡
const worksheet = sheet.getActiveSheet();
worksheet.onTableEvent('click_cell', handler);

// é—®é¢˜ï¼šåˆ‡æ¢ sheet åï¼Œäº‹ä»¶å°±å¤±æ•ˆäº†
sheet.activateSheet('sheet2'); // ä¸Šé¢çš„äº‹ä»¶å¤±æ•ˆäº†ï¼
```

### æ­£ç¡®çš„è®¾è®¡

```typescript
// âœ… æ­£ç¡®çš„è®¾è®¡
sheet.onTableEvent('click_cell', (event) => {
  // event.sheetKey è‡ªåŠ¨å‘Šè¯‰ä½ æ˜¯å“ªä¸ª sheet
  console.log(`Sheet ${event.sheetKey} è¢«ç‚¹å‡»`);
});

// åˆ‡æ¢ sheetï¼Œäº‹ä»¶ç»§ç»­æœ‰æ•ˆ
sheet.activateSheet('sheet2'); // äº‹ä»¶ä»ç„¶æœ‰æ•ˆï¼
```

## ğŸ“– å¸¸è§åœºæ™¯

### åœºæ™¯ 1: è‡ªåŠ¨ä¿å­˜

```typescript
sheet.onTableEvent('change_cell_value', (event) => {
  saveToServer({
    sheetKey: event.sheetKey,
    row: event.row,
    col: event.col,
    value: event.changedValue
  });
});
```

### åœºæ™¯ 2: ååŒç¼–è¾‘

```typescript
// æœ¬åœ°ç¼–è¾‘ â†’ å¹¿æ’­
sheet.onTableEvent('change_cell_value', (event) => {
  websocket.send({
    type: 'edit',
    sheetKey: event.sheetKey,
    row: event.row,
    col: event.col,
    value: event.changedValue
  });
});

// æ¥æ”¶è¿œç¨‹ç¼–è¾‘
websocket.onmessage = (msg) => {
  const { sheetKey, row, col, value } = msg.data;
  
  // æ‰¾åˆ°å¯¹åº”çš„ worksheet
  const worksheet = Array.from(sheet.workSheetInstances.values())
    .find(ws => ws.getKey() === sheetKey);
  
  if (worksheet) {
    worksheet.setCellValue(col, row, value);
  }
};
```

### åœºæ™¯ 3: æ¡ä»¶å¤„ç†

```typescript
sheet.onTableEvent('click_cell', (event) => {
  // åªå¤„ç†ç‰¹å®š sheet
  if (event.sheetKey === 'sheet1') {
    console.log('Sheet1 çš„å•å…ƒæ ¼è¢«ç‚¹å‡»');
  }
  
  // æˆ–è€…æ ¹æ® sheet åšä¸åŒå¤„ç†
  switch (event.sheetKey) {
    case 'sheet1':
      handleSheet1Click(event);
      break;
    case 'sheet2':
      handleSheet2Click(event);
      break;
  }
});
```

### åœºæ™¯ 4: ç»Ÿè®¡æ‰€æœ‰ sheet çš„æ“ä½œ

```typescript
const stats = {
  sheet1: { clicks: 0, edits: 0 },
  sheet2: { clicks: 0, edits: 0 }
};

sheet.onTableEvent('click_cell', (event) => {
  stats[event.sheetKey].clicks++;
});

sheet.onTableEvent('change_cell_value', (event) => {
  stats[event.sheetKey].edits++;
});

// éšæ—¶æŸ¥çœ‹ç»Ÿè®¡
console.log(stats);
```

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **äº‹ä»¶ç»‘å®šåœ¨ VTableSheet å±‚** - `sheet.onTableEvent()`
2. **è‡ªåŠ¨é™„å¸¦ sheetKey** - å›è°ƒå‚æ•°è‡ªåŠ¨åŒ…å« `event.sheetKey`
3. **åˆ‡æ¢ sheet ä¸å½±å“** - ä¸€æ¬¡ç»‘å®šï¼Œæ°¸ä¹…æœ‰æ•ˆ
4. **å‚è€ƒæˆç†Ÿæ¨¡å¼** - VTable ä¸­è½¬ VChart çš„æ–¹å¼
5. **åªæœ‰ä¸€ç§æ–¹å¼** - ç®€å•ç»Ÿä¸€ï¼Œæ˜“äºä½¿ç”¨

### æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼

```typescript
// âœ… æ­£ç¡®ï¼šåœ¨ VTableSheet å±‚ç›‘å¬
sheet.onTableEvent('click_cell', (event) => {
  console.log(`Sheet ${event.sheetKey} è¢«ç‚¹å‡»`);
});

// âŒ é”™è¯¯ï¼šä¸è¦åœ¨ WorkSheet å±‚ç›‘å¬
const worksheet = sheet.getActiveSheet();
worksheet.onTableEvent('click_cell', handler); // è¿™æ˜¯æˆ‘ä¹‹å‰çš„é”™è¯¯ç†è§£
```

æ„Ÿè°¢ä½ çš„çº æ­£ï¼è¿™ä¸ªè®¾è®¡ç¡®å®æ›´åŠ åˆç†å’Œå®ç”¨ ğŸ¯


