# ä¸‰å±‚äº‹ä»¶æ¶æ„ - å®ç°ç°çŠ¶

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

VTable Sheet çš„äº‹ä»¶ç³»ç»Ÿé‡‡ç”¨**ä¸‰å±‚æ¶æ„**è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ä»£ç                               â”‚
â”‚                       â†“                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               VTableSheet (ç”µå­è¡¨æ ¼)                     â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç¬¬ä¸‰å±‚ï¼šSpreadSheet å±‚äº‹ä»¶ (å¾…å®ç°)             â”‚    â”‚
â”‚  â”‚ â€¢ æ·»åŠ /åˆ é™¤/åˆ‡æ¢ Sheet                          â”‚    â”‚
â”‚  â”‚ â€¢ å¯¼å…¥/å¯¼å‡º                                     â”‚    â”‚
â”‚  â”‚ â€¢ è·¨ Sheet æ“ä½œ                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç¬¬äºŒå±‚ï¼šWorkSheet å±‚äº‹ä»¶ (å¾…å®ç°)               â”‚    â”‚
â”‚  â”‚ â€¢ å·¥ä½œè¡¨æ¿€æ´»/åœç”¨                               â”‚    â”‚
â”‚  â”‚ â€¢ å…¬å¼è®¡ç®—                                      â”‚    â”‚
â”‚  â”‚ â€¢ æ•°æ®åŠ è½½/æ’åº/ç­›é€‰                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â†“                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç¬¬ä¸€å±‚ï¼šTable å±‚äº‹ä»¶ (å·²å®ç° âœ…)                â”‚    â”‚
â”‚  â”‚ â€¢ å•å…ƒæ ¼ç‚¹å‡»/é€‰æ‹©                               â”‚    â”‚
â”‚  â”‚ â€¢ å•å…ƒæ ¼å€¼æ”¹å˜                                  â”‚    â”‚
â”‚  â”‚ â€¢ æ»šåŠ¨/æ‹–æ‹½ç­‰äº¤äº’                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                       â†“                                  â”‚
â”‚              TableEventRelay (äº‹ä»¶ä¸­è½¬)                  â”‚
â”‚                       â†“                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                 VTable (åº•å±‚è¡¨æ ¼)
```

## âœ… ç¬¬ä¸€å±‚ï¼šTable å±‚äº‹ä»¶ï¼ˆå·²å®ç°ï¼‰

### å®ç°æ–¹å¼

é€šè¿‡ `TableEventRelay` ä¸­è½¬ VTable çš„åŸç”Ÿäº‹ä»¶ï¼Œè‡ªåŠ¨é™„å¸¦ `sheetKey`ã€‚

### ä½¿ç”¨ç¤ºä¾‹

```typescript
const sheet = new VTableSheet(container, options);

// ç›‘å¬æ‰€æœ‰ sheet çš„å•å…ƒæ ¼ç‚¹å‡»
sheet.onTableEvent('click_cell', (event) => {
  console.log(`Sheet ${event.sheetKey} çš„å•å…ƒæ ¼ [${event.row}, ${event.col}] è¢«ç‚¹å‡»`);
});

// ç›‘å¬æ‰€æœ‰ sheet çš„å•å…ƒæ ¼å€¼æ”¹å˜
sheet.onTableEvent('change_cell_value', (event) => {
  console.log(`Sheet ${event.sheetKey} ç¼–è¾‘`);
  autoSave(event);
});

// ç›‘å¬æ‰€æœ‰ sheet çš„æ»šåŠ¨
sheet.onTableEvent('scroll', (event) => {
  console.log(`Sheet ${event.sheetKey} æ»šåŠ¨`);
});
```

### å®ç°æ–‡ä»¶

- `src/core/table-event-relay.ts` - äº‹ä»¶ä¸­è½¬å™¨
- `src/components/vtable-sheet.ts` - æä¾› `onTableEvent()` API

### ç‰¹ç‚¹

- âœ… ç»Ÿä¸€çš„ APIï¼š`sheet.onTableEvent(type, callback)`
- âœ… è‡ªåŠ¨é™„å¸¦ `sheetKey`
- âœ… å¯ç›‘å¬ä»»ä½• VTable æ”¯æŒçš„äº‹ä»¶
- âœ… å†…éƒ¨å’Œå¤–éƒ¨ä½¿ç”¨ç›¸åŒçš„æ–¹å¼

## â³ ç¬¬äºŒå±‚ï¼šWorkSheet å±‚äº‹ä»¶ï¼ˆå¾…å®ç°ï¼‰

### äº‹ä»¶å®šä¹‰

ä½äº `src/ts-types/spreadsheet-events.ts`ï¼š

```typescript
export enum WorkSheetEventType {
  // å·¥ä½œè¡¨çŠ¶æ€äº‹ä»¶
  ACTIVATED = 'worksheet:activated',
  DEACTIVATED = 'worksheet:deactivated',
  READY = 'worksheet:ready',
  RESIZED = 'worksheet:resized',

  // å…¬å¼ç›¸å…³äº‹ä»¶
  FORMULA_CALCULATE_START = 'worksheet:formula_calculate_start',
  FORMULA_CALCULATE_END = 'worksheet:formula_calculate_end',
  FORMULA_ERROR = 'worksheet:formula_error',
  FORMULA_DEPENDENCY_CHANGED = 'worksheet:formula_dependency_changed',
  FORMULA_ADDED = 'worksheet:formula_added',
  FORMULA_REMOVED = 'worksheet:formula_removed',

  // æ•°æ®æ“ä½œäº‹ä»¶
  DATA_LOADED = 'worksheet:data_loaded',
  DATA_SORTED = 'worksheet:data_sorted',
  DATA_FILTERED = 'worksheet:data_filtered',
  RANGE_DATA_CHANGED = 'worksheet:range_data_changed'
}
```

### è§„åˆ’çš„ä½¿ç”¨æ–¹å¼

```typescript
const sheet = new VTableSheet(container, options);

// ç›‘å¬å·¥ä½œè¡¨æ¿€æ´»
sheet.on(WorkSheetEventType.ACTIVATED, (event) => {
  console.log(`å·¥ä½œè¡¨ ${event.sheetKey} è¢«æ¿€æ´»`);
});

// ç›‘å¬å…¬å¼è®¡ç®—
sheet.on(WorkSheetEventType.FORMULA_CALCULATE_END, (event) => {
  console.log(`å…¬å¼è®¡ç®—å®Œæˆ: ${event.formulaCount} ä¸ªå…¬å¼, è€—æ—¶ ${event.duration}ms`);
});

// ç›‘å¬æ•°æ®åŠ è½½
sheet.on(WorkSheetEventType.DATA_LOADED, (event) => {
  console.log(`æ•°æ®åŠ è½½å®Œæˆ: ${event.rowCount} è¡Œ x ${event.colCount} åˆ—`);
});
```

### å¾…å®ç°å†…å®¹

1. **WorkSheet ç±»éœ€è¦ç»§æ‰¿ EventTarget**ï¼ˆæˆ–ä½¿ç”¨å…¶ä»–äº‹ä»¶æœºåˆ¶ï¼‰
2. **åœ¨é€‚å½“çš„æ—¶æœºè§¦å‘è¿™äº›äº‹ä»¶**
   - å·¥ä½œè¡¨æ¿€æ´»/åœç”¨æ—¶
   - å…¬å¼è®¡ç®—å‰å
   - æ•°æ®åŠ è½½/æ’åº/ç­›é€‰å
3. **VTableSheet å¯èƒ½éœ€è¦ä¸­è½¬è¿™äº›äº‹ä»¶**ï¼ˆç±»ä¼¼ TableEventRelayï¼‰

### å®ç°ä¼˜å…ˆçº§

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå»ºè®®ä¼˜å…ˆå®ç°ï¼š
1. ğŸ”¥ `ACTIVATED` / `DEACTIVATED` - Sheet åˆ‡æ¢
2. ğŸ”¥ `FORMULA_CALCULATE_END` / `FORMULA_ERROR` - å…¬å¼è®¡ç®—åé¦ˆ
3. ğŸ“Š `DATA_LOADED` - æ•°æ®åŠ è½½å®Œæˆ
4. ğŸ“Š `DATA_SORTED` / `DATA_FILTERED` - æ•°æ®æ“ä½œåé¦ˆ

## â³ ç¬¬ä¸‰å±‚ï¼šSpreadSheet å±‚äº‹ä»¶ï¼ˆå¾…å®ç°ï¼‰

### äº‹ä»¶å®šä¹‰

ä½äº `src/ts-types/spreadsheet-events.ts`ï¼š

```typescript
export enum SpreadSheetEventType {
  // ç”µå­è¡¨æ ¼ç”Ÿå‘½å‘¨æœŸ
  READY = 'spreadsheet:ready',
  DESTROYED = 'spreadsheet:destroyed',
  RESIZED = 'spreadsheet:resized',

  // Sheet ç®¡ç†äº‹ä»¶
  SHEET_ADDED = 'spreadsheet:sheet_added',
  SHEET_REMOVED = 'spreadsheet:sheet_removed',
  SHEET_RENAMED = 'spreadsheet:sheet_renamed',
  SHEET_ACTIVATED = 'spreadsheet:sheet_activated',
  SHEET_MOVED = 'spreadsheet:sheet_moved',
  SHEET_VISIBILITY_CHANGED = 'spreadsheet:sheet_visibility_changed',

  // å¯¼å…¥å¯¼å‡ºäº‹ä»¶
  IMPORT_START = 'spreadsheet:import_start',
  IMPORT_COMPLETED = 'spreadsheet:import_completed',
  IMPORT_ERROR = 'spreadsheet:import_error',
  EXPORT_START = 'spreadsheet:export_start',
  EXPORT_COMPLETED = 'spreadsheet:export_completed',
  EXPORT_ERROR = 'spreadsheet:export_error',

  // è·¨ Sheet æ“ä½œäº‹ä»¶
  CROSS_SHEET_REFERENCE_UPDATED = 'spreadsheet:cross_sheet_reference_updated',
  CROSS_SHEET_FORMULA_CALCULATE_START = 'spreadsheet:cross_sheet_formula_calculate_start',
  CROSS_SHEET_FORMULA_CALCULATE_END = 'spreadsheet:cross_sheet_formula_calculate_end'
}
```

### è§„åˆ’çš„ä½¿ç”¨æ–¹å¼

```typescript
const sheet = new VTableSheet(container, options);

// ç›‘å¬ç”µå­è¡¨æ ¼åˆå§‹åŒ–å®Œæˆ
sheet.on(SpreadSheetEventType.READY, () => {
  console.log('ç”µå­è¡¨æ ¼åˆå§‹åŒ–å®Œæˆ');
});

// ç›‘å¬ Sheet æ·»åŠ 
sheet.on(SpreadSheetEventType.SHEET_ADDED, (event) => {
  console.log(`æ–°å¢ Sheet: ${event.sheetTitle} (${event.sheetKey})`);
});

// ç›‘å¬ Sheet åˆ‡æ¢
sheet.on(SpreadSheetEventType.SHEET_ACTIVATED, (event) => {
  console.log(`åˆ‡æ¢åˆ° Sheet: ${event.sheetTitle}`);
  console.log(`ä¹‹å‰çš„ Sheet: ${event.previousSheetTitle}`);
});

// ç›‘å¬å¯¼å…¥å®Œæˆ
sheet.on(SpreadSheetEventType.IMPORT_COMPLETED, (event) => {
  console.log(`å¯¼å…¥å®Œæˆ: ${event.sheetCount} ä¸ª Sheet`);
});
```

### å¾…å®ç°å†…å®¹

1. **VTableSheet éœ€è¦åœ¨ç›¸åº”æ“ä½œæ—¶è§¦å‘äº‹ä»¶**
   - `addSheet()` â†’ `SHEET_ADDED`
   - `removeSheet()` â†’ `SHEET_REMOVED`
   - `renameSheet()` â†’ `SHEET_RENAMED`
   - `switchSheet()` â†’ `SHEET_ACTIVATED`
   - ç­‰ç­‰
2. **å®Œå–„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½çš„äº‹ä»¶è§¦å‘**
3. **å®ç°è·¨ Sheet å¼•ç”¨è¿½è¸ªå’Œäº‹ä»¶è§¦å‘**

### å®ç°ä¼˜å…ˆçº§

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œå»ºè®®ä¼˜å…ˆå®ç°ï¼š
1. ğŸ”¥ `SHEET_ADDED` / `SHEET_REMOVED` - Sheet ç®¡ç†
2. ğŸ”¥ `SHEET_ACTIVATED` - Sheet åˆ‡æ¢
3. ğŸ”¥ `SHEET_RENAMED` - Sheet é‡å‘½å
4. ğŸ“Š `IMPORT_COMPLETED` / `EXPORT_COMPLETED` - å¯¼å…¥å¯¼å‡ºåé¦ˆ
5. ğŸ”§ `CROSS_SHEET_REFERENCE_UPDATED` - è·¨ Sheet å¼•ç”¨

## ğŸ“ å®ç°å»ºè®®

### å¯¹äº WorkSheet å±‚äº‹ä»¶

**æ–¹æ¡ˆ 1ï¼šWorkSheet ç»§æ‰¿ EventTargetï¼ˆæ¨èï¼‰**

```typescript
// WorkSheet.ts
import { EventTarget } from '../event/event-target';

export class WorkSheet extends EventTarget {
  // ...

  private notifyActivated(): void {
    this.fire(WorkSheetEventType.ACTIVATED, {
      sheetKey: this.sheetKey,
      sheetTitle: this.getTitle()
    });
  }

  // åœ¨å…¬å¼è®¡ç®—å
  private onFormulaCalculateEnd(formulaCount: number, duration: number): void {
    this.fire(WorkSheetEventType.FORMULA_CALCULATE_END, {
      sheetKey: this.sheetKey,
      formulaCount,
      duration
    });
  }
}
```

**æ–¹æ¡ˆ 2ï¼šé€šè¿‡ VTableSheet ä¸­è½¬**

ç±»ä¼¼ TableEventRelayï¼Œåˆ›å»º WorkSheetEventRelayã€‚

### å¯¹äº SpreadSheet å±‚äº‹ä»¶

**ç›´æ¥åœ¨ VTableSheet ä¸­è§¦å‘**

```typescript
// VTableSheet.ts
import { EventTarget } from './event/event-target';

export class VTableSheet extends EventTarget {
  // ...

  addSheet(options: ISheetDefine): string {
    const sheetKey = this.sheetManager.addSheet(options);
    
    // è§¦å‘äº‹ä»¶
    this.fire(SpreadSheetEventType.SHEET_ADDED, {
      sheetKey,
      sheetTitle: options.title,
      index: this.sheetManager.getSheetIndex(sheetKey)
    });
    
    return sheetKey;
  }

  removeSheet(sheetKey: string): void {
    const sheetTitle = this.sheetManager.getSheetTitle(sheetKey);
    const index = this.sheetManager.getSheetIndex(sheetKey);
    
    this.sheetManager.removeSheet(sheetKey);
    
    // è§¦å‘äº‹ä»¶
    this.fire(SpreadSheetEventType.SHEET_REMOVED, {
      sheetKey,
      sheetTitle,
      index
    });
  }
}
```

## ğŸ¯ å®ç°è·¯çº¿å›¾

### Phase 1: SpreadSheet å±‚æ ¸å¿ƒäº‹ä»¶ï¼ˆå»ºè®®ä¼˜å…ˆï¼‰

- [ ] `SHEET_ADDED`
- [ ] `SHEET_REMOVED`
- [ ] `SHEET_RENAMED`
- [ ] `SHEET_ACTIVATED`
- [ ] `READY`

**é¢„è®¡å·¥ä½œé‡ï¼š** 1-2 å¤©

### Phase 2: WorkSheet å±‚æ ¸å¿ƒäº‹ä»¶

- [ ] `ACTIVATED` / `DEACTIVATED`
- [ ] `FORMULA_CALCULATE_END`
- [ ] `FORMULA_ERROR`
- [ ] `DATA_LOADED`

**é¢„è®¡å·¥ä½œé‡ï¼š** 2-3 å¤©

### Phase 3: å¯¼å…¥å¯¼å‡ºäº‹ä»¶

- [ ] `IMPORT_START` / `IMPORT_COMPLETED` / `IMPORT_ERROR`
- [ ] `EXPORT_START` / `EXPORT_COMPLETED` / `EXPORT_ERROR`

**é¢„è®¡å·¥ä½œé‡ï¼š** 1 å¤©

### Phase 4: é«˜çº§äº‹ä»¶

- [ ] `CROSS_SHEET_REFERENCE_UPDATED`
- [ ] å…¶ä»–å…¬å¼ç›¸å…³äº‹ä»¶
- [ ] æ•°æ®ç­›é€‰/æ’åºäº‹ä»¶

**é¢„è®¡å·¥ä½œé‡ï¼š** 3-5 å¤©

## ğŸ“š ç›¸å…³æ–‡ä»¶

### å·²å®ç°
- `src/core/table-event-relay.ts` - Table å±‚äº‹ä»¶ä¸­è½¬
- `src/components/vtable-sheet.ts` - æä¾› `onTableEvent()` API

### å¾…ä½¿ç”¨
- `src/ts-types/spreadsheet-events.ts` - WorkSheet å’Œ SpreadSheet å±‚äº‹ä»¶å®šä¹‰
- `src/event/event-target.ts` - åŸºç¡€äº‹ä»¶ç±»

### å¯èƒ½éœ€è¦åˆ›å»º
- `src/core/worksheet-event-relay.ts` - WorkSheet å±‚äº‹ä»¶ä¸­è½¬ï¼ˆå¯é€‰ï¼‰

## âœ… æ€»ç»“

| å±‚çº§ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **Table å±‚** | âœ… **å·²å®ç°** | é€šè¿‡ `onTableEvent()` ç›‘å¬ VTable åŸç”Ÿäº‹ä»¶ |
| **WorkSheet å±‚** | â³ **å¾…å®ç°** | äº‹ä»¶å®šä¹‰å·²å®Œæˆï¼Œéœ€è¦å®ç°è§¦å‘é€»è¾‘ |
| **SpreadSheet å±‚** | â³ **å¾…å®ç°** | äº‹ä»¶å®šä¹‰å·²å®Œæˆï¼Œéœ€è¦å®ç°è§¦å‘é€»è¾‘ |

---

**éå¸¸æŠ±æ­‰ä¹‹å‰è¯¯åˆ äº†äº‹ä»¶å®šä¹‰ï¼ç°åœ¨å·²ç»æ¢å¤ï¼Œå¯ä»¥ç»§ç»­å®Œå–„åç»­çš„äº‹ä»¶åŠŸèƒ½äº†ï¼** ğŸ™

